name: APK Size Analysis with Diffuse

on:
  pull_request:
    branches: [ "main" ]

jobs:
  diffuse:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: write  # Required to post comments

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Set up JDK 23
        uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # Build PR APK
      - name: Build PR APK
        run: ./gradlew assembleProdRelease --parallel --daemon

      - name: List APK outputs
        run: |
          echo "Listing APK outputs:"
          find app/build/outputs/apk -name "*.apk"

      # Download base APK from latest release or build from main branch
      - name: Download base APK from latest release
        id: download_base
        continue-on-error: true
        run: |
          # Get latest release info
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest)
          
          # Extract APK download URL
          APK_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
          
          if [ -z "$APK_URL" ] || [ "$APK_URL" = "null" ]; then
            echo "No APK found in latest release, will build from main branch instead"
            echo "has_apk=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Downloading base APK from: $APK_URL"
          curl -L -o base.apk "$APK_URL"
          echo "has_apk=true" >> $GITHUB_OUTPUT

      # Build base APK from main branch if not available from release
      - name: Checkout main branch
        if: steps.download_base.outputs.has_apk != 'true'
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-branch

      - name: Build base APK from main
        if: steps.download_base.outputs.has_apk != 'true'
        run: |
          cd main-branch
          ./gradlew assembleProdRelease --parallel --daemon
          cp app/build/outputs/apk/prod/release/app-prod-release.apk ../base.apk
          cd ..

      # Run Diffuse comparison using the action
      - name: Run Diffuse
        id: diffuse
        uses: usefulness/diffuse-action@v1
        continue-on-error: true
        with:
          old-file-path: base.apk
          new-file-path: app/build/outputs/apk/prod/release/app-prod-release.apk

      # Post or update comment on PR
      - name: Find existing Diffuse comment
        uses: peter-evans/find-comment@v3
        id: find_comment
        if: success() || failure()
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: 'üìä APK Size Analysis'

      - name: Create or update PR comment
        uses: peter-evans/create-or-update-comment@v4
        if: always()
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ## üìä APK Size Analysis
            
            Comparing `${{ github.base_ref }}` (base) ‚Üí `${{ github.head_ref }}` (this PR)
            
            ${{ steps.diffuse.outputs.diff-gh-comment || '‚ö†Ô∏è Diffuse analysis failed. Check the workflow logs for details.' }}
            
            ---
            _Generated by [Diffuse](https://github.com/JakeWharton/diffuse) via [diffuse-action](https://github.com/usefulness/diffuse-action)_

      # Upload APKs as artifacts for manual inspection
      - name: Upload APKs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apks-comparison
          path: |
            base.apk
            app/build/outputs/apk/prod/release/app-prod-release.apk
          retention-days: 7
