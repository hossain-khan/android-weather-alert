name: Android Release Build

# Workflow that builds release APK and AAB for:
# 1. Snapshot builds: Each time code changes on main branch
# 2. Release builds: When a GitHub release is published (automatically attaches APK and AAB to release)
# This allows developers and testers to easily download the latest release APK.
# AAB (Android App Bundle) is provided for Google Play Store distribution.
#
# See:
# - https://github.com/hossain-khan/android-weather-alert/tree/main/keystore
# - https://github.com/hossain-khan/android-weather-alert/blob/main/app/build.gradle.kts (signing configuration)

on:
  push:
    branches: [ "main" ]
  # This allows manual triggering of the workflow, which results in making Android Release APK build
  # Go to the "Actions" tab in the repository, select this workflow, and click the "Run workflow" button to run it manually.
  workflow_dispatch:
  # This is triggered when a release is published
  release:
    types: [published]

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to upload release assets
      actions: read    # Required to read workflow artifacts
      
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Identify build context
        run: |
          echo "üîç Build context information:"
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref name: ${{ github.ref_name }}"
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "üéâ Building for GitHub release: ${{ github.ref_name }}"
          else
            echo "üì¶ Building snapshot from main branch"
          fi

      - name: Decode keystore from base64
        id: keystore
        run: |
          if [ -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "‚ö†Ô∏è KEYSTORE_BASE64 secret is not set, using debug keystore for signing"
            echo "USE_RELEASE_KEYSTORE=false" >> $GITHUB_OUTPUT
          else
            base64 -d <<< "${{ secrets.KEYSTORE_BASE64 }}" > keystore/weather-alert-release.keystore
            if [ ! -s keystore/weather-alert-release.keystore ]; then
              echo "‚ùå Failed to decode keystore file"
              exit 1
            fi
            echo "‚úÖ Release keystore decoded successfully"
            echo "USE_RELEASE_KEYSTORE=true" >> $GITHUB_OUTPUT
          fi

      - name: Create keystore.properties for release signing
        if: steps.keystore.outputs.USE_RELEASE_KEYSTORE == 'true'
        run: |
          echo "storeFile=keystore/weather-alert-release.keystore" > keystore.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> keystore.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> keystore.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties
          echo "‚úÖ keystore.properties created for release signing"

      - name: Build Release APK and AAB
        run: ./gradlew assembleProdRelease bundleProdRelease --parallel --daemon

      - name: Extract version name
        id: version
        run: |
          VERSION_NAME=$(grep -o 'versionName = "[^"]*"' app/build.gradle.kts | cut -d'"' -f2)
          echo "VERSION=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "App version name extracted: $VERSION_NAME"

      - name: Rename APK and AAB
        run: |
          mkdir -p artifact
          cp app/build/outputs/apk/prod/release/app-prod-release.apk artifact/weather-alert-v${{ steps.version.outputs.VERSION }}.apk
          cp app/build/outputs/bundle/prodRelease/app-prod-release.aab artifact/weather-alert-v${{ steps.version.outputs.VERSION }}.aab

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: weather-alert-apk
          path: artifact/weather-alert-v${{ steps.version.outputs.VERSION }}.apk
          # Use maximum allowed retention period
          # https://github.com/actions/upload-artifact?tab=readme-ov-file#retention-period
          retention-days: 30

      - name: Upload Release AAB
        uses: actions/upload-artifact@v4
        with:
          name: weather-alert-aab
          path: artifact/weather-alert-v${{ steps.version.outputs.VERSION }}.aab
          retention-days: 30

      # If this is running due to a GitHub release, attach the APK and AAB to the release
      - name: Attach APK and AAB to GitHub Release
        if: github.event_name == 'release'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Attaching APK and AAB to GitHub release..."
          
          # Get release information
          RELEASE_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ github.ref_name }}" | \
            jq -r .id)
          
          if [ "$RELEASE_ID" = "null" ] || [ -z "$RELEASE_ID" ]; then
            echo "‚ùå Could not find release for tag ${{ github.ref_name }}"
            exit 1
          fi
          
          echo "Found release ID: $RELEASE_ID"
          
          # Upload APK to the release
          APK_FILE="artifact/weather-alert-v${{ steps.version.outputs.VERSION }}.apk"
          APK_NAME="weather-alert-v${{ steps.version.outputs.VERSION }}.apk"
          
          echo "Uploading $APK_NAME to release..."
          
          HTTP_CODE=$(curl -s -w "%{http_code}" -o upload_response.json \
            -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$APK_FILE" \
            "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$APK_NAME")
          
          if [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ Successfully attached APK to GitHub release"
            DOWNLOAD_URL=$(jq -r .browser_download_url upload_response.json)
            echo "APK download URL: $DOWNLOAD_URL"
          else
            echo "‚ùå Failed to upload APK (HTTP $HTTP_CODE)"
            cat upload_response.json
            exit 1
          fi
          
          # Upload AAB to the release
          AAB_FILE="artifact/weather-alert-v${{ steps.version.outputs.VERSION }}.aab"
          AAB_NAME="weather-alert-v${{ steps.version.outputs.VERSION }}.aab"
          
          echo "Uploading $AAB_NAME to release..."
          
          HTTP_CODE=$(curl -s -w "%{http_code}" -o upload_response_aab.json \
            -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$AAB_FILE" \
            "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$AAB_NAME")
          
          if [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ Successfully attached AAB to GitHub release"
            DOWNLOAD_URL=$(jq -r .browser_download_url upload_response_aab.json)
            echo "AAB download URL: $DOWNLOAD_URL"
          else
            echo "‚ùå Failed to upload AAB (HTTP $HTTP_CODE)"
            cat upload_response_aab.json
            exit 1
          fi
